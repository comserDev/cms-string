# DJB2 해시 알고리즘 및 태그 스타일링 설명

`cms::LoggerBase::applyStyling` 함수에서 로그 태그(`[TAG]`)의 고유 색상을 결정하기 위해 사용되는 **DJB2 알고리즘**에 대한 기술 문서입니다.

---

## 1. DJB2 알고리즘 개요
DJB2는 Daniel J. Bernstein이 발표한 비암호화 해시 함수로, 구현이 매우 단순하면서도 문자열에 대해 충돌이 적고 분포가 고르기로 유명합니다. 특히 CPU 연산 자원과 메모리가 제한된 임베디드 시스템에서 문자열을 특정 숫자 값으로 변환할 때 가장 효율적인 선택지 중 하나입니다.

## 2. 핵심 작동 원리

### 매직 넘버 33 (Bit Shift & Add)
알고리즘의 핵심 연산은 다음과 같습니다:
```cpp
hash = ((hash << 5) + hash) + (unsigned char)c;
```
이는 수학적으로 **`hash * 33 + c`**와 동일합니다.
- **왜 33인가?**: 33은 ASCII 문자열 해싱에서 비트를 적절히 섞어주어 충돌을 최소화하는 최적의 소수(Prime)에 가까운 특성을 가집니다.
- **최적화**: 곱셈 연산(`*`) 대신 비트 시프트(`<<`)와 덧셈(`+`)을 사용하여 CPU 사이클을 획기적으로 절약합니다.

### 초기값 5381
해시 값은 `0`이 아닌 `5381`에서 시작합니다. 이는 비트 패턴상 적절한 불균형을 가지고 있어, 짧은 문자열에서도 해시 값이 빠르게 확산(Diffusion)되도록 돕습니다.

## 3. 우리 시스템에서의 응용

### 대소문자 정규화 (Normalization)
```cpp
char c = (*h >= 'a' && *h <= 'z') ? (*h - 'a' + 'A') : *h;
```
해시를 계산하기 전 모든 소문자를 대문자로 변환합니다. 이를 통해 `[WiFi]`와 `[wifi]` 태그가 서로 다른 색상으로 출력되는 것을 방지하고, 내용이 같다면 항상 동일한 색상을 보장합니다.

### 가독성을 고려한 색상 매핑
계산된 해시 값을 ANSI 팔레트로 변환할 때, 터미널에서 읽기 좋은 색상 범위를 선택합니다.
```cpp
static const char* TAG_COLORS[] = { "92", "93", "94", "95", "96", "32", "33", "35", "36" };
const char* color = TAG_COLORS[hash % 9];
```
- **색상 제한**: 밝은 고대비 ANSI 색상만 선택해 검정/흰 배경 모두에서 가독성을 확보합니다.
- **일관성**: 해시 결과에 나머지 연산(`%`)을 적용하여 한정된 색상 풀 안에서 태그별 고유 색상을 할당합니다.

### 중요 키워드 강조 (Priority Styling)
태그 스타일링과 별개로, 메시지 본문에 `ERROR`, `CRITICAL`, `FATAL`, `FAIL` 등이 포함되면 **Bold Red** 스타일을 강제로 적용합니다. 이는 시스템의 위험 신호를 사용자가 가장 먼저 인지하도록 하기 위함입니다.

## 4. 결론
DJB2 알고리즘 도입을 통해 다음과 같은 이점을 얻었습니다:
1. **일관성**: 동일한 태그는 재부팅 후에도 항상 같은 색상으로 표시되어 디버깅 직관성을 높입니다.
2. **초경량 성능**: 복잡한 부동 소수점 연산이나 큰 룩업 테이블 없이 비트 연산만으로 동작하여 실시간 로깅에 적합합니다.
3. **가독성**: 수많은 모듈의 로그가 섞여 나오는 멀티태스킹 환경에서 시각적으로 즉각적인 모듈 구분을 가능하게 합니다.

---

## 5. 관련 소스
- `src/cmsAsyncLogger.cpp` (`cms::LoggerBase::applyStyling`)
- `src/cmsAsyncLogger.h`

---
*작성자: comser.dev*
*최종 수정일: 2025-01-07*
